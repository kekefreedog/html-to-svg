{"version":3,"file":"html-to-svg.modern.mjs","sources":["../src/utils/dom-walk.js","../src/utils/dom-get-zindex.js","../src/utils/range-get-client-rects.js","../src/utils/dom-render-svg.js","../src/renderers/canvas.js","../src/renderers/div.js","../src/renderers/svg.js","../src/renderers/text.js","../src/renderers/image.js","../src/index.js"],"sourcesContent":["async function walk (element, callback, { sort = () => 1 } = {}) {\n  if (!await callback(element)) return\n\n  for (const child of Array.from(element.children).sort(sort)) {\n    await walk(child, callback, { sort })\n  }\n}\n\nexport default walk\n","export default el => {\n  const zindex = window.getComputedStyle(el).getPropertyValue('z-index')\n  return zindex === 'auto' ? 0 : parseInt(zindex ?? 0)\n}\n","/* global DocumentFragment */\n\n// Return Range.clientRects with their corresponding DocumentFragment\nexport default function (node, text = node.innerText || node.textContent) {\n  const range = document.createRange()\n\n  const rects = []\n  for (let i = 0; i < node.length; i++) {\n    range.setStart(node, 0)\n    range.setEnd(node, (i + 1))\n\n    const clientRects = range.getClientRects()\n\n    const index = clientRects.length - 1\n    rects[index] = rects[index] ?? { text: '' }\n    rects[index].rect = clientRects[index]\n    rects[index].text += text.charAt(i)\n  }\n\n  return rects.map(rect => {\n    rect.fragment = new DocumentFragment()\n    rect.fragment.textContent = rect.text\n    return rect\n  })\n}\n","export default function (name, props = {}, parent) {\n  const NS = 'http://www.w3.org/2000/svg'\n\n  const element = document.createElementNS(NS, name)\n  if (name === 'svg') element.setAttributeNS('http://www.w3.org/2000/xmlns/', 'xmlns', NS)\n  for (const key in props) {\n    if (props[key] === null || props[key] === undefined) continue\n    element.setAttribute(key, props[key])\n  }\n\n  if (parent) parent.appendChild(element)\n  return element\n}\n","import $ from '../utils/dom-render-svg'\n\nexport default ({\n  debug,\n  fonts\n}) => async (element, { x, y, width, height, style }) => $('image', {\n  x,\n  y,\n  width,\n  height,\n  href: element.toDataURL('image/png')\n})\n","import $ from '../utils/dom-render-svg'\n\nexport default ({\n  debug,\n  fonts\n}) => async (element, { x, y, width, height, style }) => {\n  if (!width || !height) return\n\n  // TODO background-image\n  // TODO border\n  const backgroundColor = style.getPropertyValue('background-color')\n\n  // Skip visually empty blocks\n  if (!backgroundColor || backgroundColor === 'none' || backgroundColor === 'transparent') return\n  if (backgroundColor.startsWith('rgba')) {\n    const rgba = backgroundColor.match(/[\\d.]+/g)\n    if (rgba[3] === '0') return\n  }\n\n  return $('rect', {\n    x,\n    y,\n    width,\n    height,\n    fill: backgroundColor,\n    rx: parseInt(style.getPropertyValue('border-radius')) || null\n  })\n}\n","/* global XMLSerializer, btoa */\nimport $ from '../utils/dom-render-svg'\n\nexport default ({\n  debug,\n  fonts\n}) => async (element, { x, y, width, height, style }) => $('image', {\n  x,\n  y,\n  width,\n  height,\n  href: 'data:image/svg+xml;base64,' + btoa(new XMLSerializer().serializeToString(element))\n})\n","// TODO text-decoration\n\nimport $ from '../utils/dom-render-svg'\n\nconst matchFont = s => ({ family, style = 'normal', weight = '400' } = {}) =>\n  family === (s.getPropertyValue('font-family') ?? '').replace(/['\"]/g, '') &&\n    style === (s.getPropertyValue('font-style') ?? 'normal') &&\n    weight === (s.getPropertyValue('font-weight') ?? '400')\n\nexport default ({\n  debug,\n  fonts\n}) => async (string, { x, y, width, height, style }) => {\n  if (!string) return\n\n  const g = $('g')\n\n  // Find font\n  const font = fonts.find(matchFont(style))\n  if (!font) throw new Error(`Cannot find font '${style.getPropertyValue('font-family')} ${style.getPropertyValue('font-style')} ${style.getPropertyValue('font-weight')}'`)\n\n  // Extract font metrics\n  const { unitsPerEm } = font.opentype\n  const ascender = font.opentype.tables.hhea.ascender\n  const descender = font.opentype.tables.hhea.descender\n\n  // Extract CSS props\n  const letterSpacing = style.getPropertyValue('letter-spacing')\n  const fontSize = parseFloat(style.getPropertyValue('font-size'))\n\n  // Compute metrics\n  const lineBox = (ascender - descender) / unitsPerEm\n  const leading = (fontSize * lineBox) - Math.abs(descender / unitsPerEm) * fontSize\n\n  // Render various metrics for debug\n  line('start', 0, { orientation: 'vertical', stroke: 'red' })\n  line('end', width, { orientation: 'vertical', stroke: 'red' })\n  line('leading', leading, { stroke: '#4b96ff' })\n\n  if (letterSpacing !== 'normal') {\n    // Render letter by letter in case of non-default letter-spacing\n    for (const c of string) {\n      $('path', {\n        d: font.opentype.getPath(c, x, y + leading, fontSize).toPathData(3),\n        fill: style.getPropertyValue('color')\n      }, g)\n      x += font.opentype.getAdvanceWidth(c, fontSize) + parseFloat(letterSpacing)\n    }\n  } else {\n    // Render string\n    $('path', {\n      d: font.opentype.getPath(string, x, y + leading, fontSize, {\n        features: {\n          // TODO extract from CSS props\n          liga: true,\n          rlig: true\n        }\n      }).toPathData(3),\n      fill: style.getPropertyValue('color')\n    }, g)\n  }\n\n  return g\n\n  function line (title, v, { orientation = 'horizontal', stroke = 'black' } = {}) {\n    return debug && $('line', {\n      title,\n      'data-value': v,\n      x1: orientation === 'horizontal' ? x : x + v,\n      x2: orientation === 'horizontal' ? x + width : x + v,\n      y1: orientation === 'horizontal' ? y + v : y,\n      y2: orientation === 'horizontal' ? y + v : y + height,\n      stroke,\n      class: 'debug'\n    }, g)\n  }\n}\n","import $ from '../utils/dom-render-svg'\n\nexport default ({\n  debug,\n  fonts\n}) => async (element, { x, y, width, height, style }) => {\n  if (!width || !height) return\n  if (!element.src) return\n\n  return $('image', {\n    x,\n    y,\n    width,\n    height,\n    href: element.src\n  })\n}\n","/* global Node */\nimport Opentype from 'opentype.js'\nimport walk from './utils/dom-walk'\nimport getZIndex from './utils/dom-get-zindex'\nimport getClientRects from './utils/range-get-client-rects'\n\nimport $ from './utils/dom-render-svg'\nimport * as RENDERERS from './renderers'\n\nexport default function ({\n  debug = false,\n  ignore = '',\n  fonts = []\n} = {}) {\n  // Init curried renderers\n  const renderers = {}\n  for (const k in RENDERERS) {\n    renderers[k] = RENDERERS[k]({ debug, fonts })\n  }\n\n  return {\n    // Preload all fonts before resolving\n    preload: async function () {\n      for (const font of fonts) {\n        if (font.opentype) continue\n        font.opentype = await new Promise(resolve => {\n          Opentype.load(font.url, (error, font) => {\n            if (error) throw error\n            resolve(font)\n          })\n        })\n      }\n    },\n\n    // Clear cache and delete all resources\n    destroy: function () {\n      for (const font of fonts) delete font.opentype\n    },\n\n    // Render the HTML container as a shadow SVG\n    render: async function (container) {\n      const viewBox = container.getBoundingClientRect()\n\n      // Create the SVG container\n      const svg = $('svg', {\n        viewBox: `0 0 ${viewBox.width} ${viewBox.height}`,\n        width: viewBox.width,\n        height: viewBox.height,\n        preserveAspectRatio: 'none'\n      })\n\n      // Set the parent to the current SVG.\n      // This parent will change during the walk\n      let parent = svg\n\n      // Render every children\n      await walk(container, async element => {\n        if (ignore && element !== container && element.matches(ignore)) return\n\n        // TODO opacity\n        const style = window.getComputedStyle(element)\n        const { x, y, width, height } = element.getBoundingClientRect()\n\n        // Handle CSS clip-path property\n        const clipPathValue = style.getPropertyValue('clip-path')\n        if (clipPathValue !== 'none') {\n          parent = $('g', null, svg)\n          // WARNING: CSS clip-path implementation is not done yet on arnaudjuracek/svg-to-pdf\n          parent.setAttribute('style', `clip-path: ${clipPathValue}`)\n        }\n\n        // Render element\n        const render = renderers[element.tagName] ?? renderers.div\n        const rendered = await render(element, {\n          x: x - viewBox.x,\n          y: y - viewBox.y,\n          width,\n          height,\n          style\n        })\n\n        if (rendered) parent.appendChild(rendered)\n\n        // Render text nodes inside the element\n        if (element.innerText) {\n          for (const node of element.childNodes) {\n            if (node.nodeType !== Node.TEXT_NODE) continue\n            if (!node.textContent.length) continue\n\n            // Text interface does not provide a .innerText method, which would be\n            // more appropriate than textContent as it skips non-rendered whitespaces\n            // Splitting white-space leading Text trick the browser to recompute\n            // the layout itself, dealing with implicit space between adjacent nodes\n            if (/^\\s/.test(node.textContent)) {\n              node.splitText(1)\n              continue\n            }\n\n            for (const { rect, fragment } of getClientRects(node)) {\n              try {\n                const text = await renderers.text(fragment.textContent.trimEnd(), {\n                  x: rect.x - viewBox.x,\n                  y: rect.y - viewBox.y,\n                  width: rect.width,\n                  height: rect.height,\n                  style\n                })\n                if (text) parent.appendChild(text)\n              } catch (error) {\n                // TODO[improve] error handling\n                console.warn(new Error(`Rendering failed for the following text: '${fragment.textContent}'`, { cause: error }))\n                console.warn(error)\n              }\n            }\n          }\n        }\n\n        // Continue walking\n        return true\n      }, {\n        sort: (a, b) => {\n          a.zIndex = a.zIndex ?? getZIndex(a)\n          b.zIndex = b.zIndex ?? getZIndex(b)\n          return a.zIndex - b.zIndex\n        }\n      })\n\n      return svg\n    }\n  }\n}\n"],"names":["async","walk","element","callback","sort","child","Array","from","children","getZIndex","el","zindex","window","getComputedStyle","getPropertyValue","parseInt","node","text","innerText","textContent","range","document","createRange","rects","i","length","_rects$index","setStart","setEnd","clientRects","getClientRects","index","rect","charAt","map","fragment","DocumentFragment","$","name","props","parent","NS","createElementNS","setAttributeNS","key","setAttribute","appendChild","div","x","y","width","height","style","backgroundColor","startsWith","match","fill","rx","svg","href","btoa","XMLSerializer","serializeToString","debug","fonts","string","g","font","find","s","family","weight","_s$getPropertyValue","_s$getPropertyValue2","_s$getPropertyValue3","replace","Error","unitsPerEm","opentype","ascender","tables","hhea","descender","letterSpacing","fontSize","parseFloat","leading","Math","abs","line","orientation","stroke","c","d","getPath","toPathData","getAdvanceWidth","features","liga","rlig","title","v","x1","x2","y1","y2","class","toDataURL","src","ignore","renderers","k","RENDERERS","preload","Promise","resolve","Opentype","load","url","error","destroy","render","container","viewBox","getBoundingClientRect","preserveAspectRatio","_renderers$element$ta","matches","clipPathValue","tagName","rendered","childNodes","nodeType","Node","TEXT_NODE","test","splitText","trimEnd","console","warn","cause","a","b","_a$zIndex","_b$zIndex","zIndex"],"mappings":"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"}