import t from"opentype.js";import e from"fs";import n from"path";async function r(t,e,{sort:n=(()=>1)}={}){if(await e(t))for(const o of Array.from(t.children).sort(n))await r(o,e,{sort:n})}var o=t=>{const e=window.getComputedStyle(t).getPropertyValue("z-index");return"auto"===e?0:parseInt(null!=e?e:0)};function i(t,e=t.innerText||t.textContent){const n=document.createRange(),r=[];for(let i=0;i<t.length;i++){var o;n.setStart(t,0),n.setEnd(t,i+1);const a=n.getClientRects(),l=a.length-1;r[l]=null!=(o=r[l])?o:{text:""},r[l].rect=a[l],r[l].text+=e.charAt(i)}return r.map(t=>(t.fragment=new DocumentFragment,t.fragment.textContent=t.text,t))}function a(t,e={},n){const r="http://www.w3.org/2000/svg",o=document.createElementNS(r,t);"svg"===t&&o.setAttributeNS("http://www.w3.org/2000/xmlns/","xmlns",r);for(const t in e)null!=e[t]&&o.setAttribute(t,e[t]);return n&&n.appendChild(o),o}function l(){return l=Object.assign?Object.assign.bind():function(t){for(var e=1;e<arguments.length;e++){var n=arguments[e];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(t[r]=n[r])}return t},l.apply(this,arguments)}function s(t){return!t||"none"===t||"transparent"===t||!(!t.startsWith("rgba")||"0"!==t.match(/[\d.]+/g)[3])}var c=({})=>async(t,{x:e,y:n,width:r,height:o,style:i})=>{if(!r||!o)return;const c=i.getPropertyValue("background-color");if(s(c))return;const g={stroke:"none","stroke-width":1},h=i.getPropertyValue("border-color");return"none"===i.getPropertyValue("border-style")||s(h)||(g.stroke=h,g["stroke-width"]=i.getPropertyValue("border-width")),a("rect",l({x:e,y:n,width:r,height:o},g,{fill:c,rx:parseInt(i.getPropertyValue("border-radius"))||null}))},g=({cache:t})=>async(e,{x:n,y:r,width:o,height:i},{rasterizeNestedSVG:l=!0}={})=>{for(const n of e.querySelectorAll("image[href]")){const e=n.getAttribute("href");if(!t.has(e)){const n=await new Promise(t=>{const n=new XMLHttpRequest;n.open("GET",e,!0),n.responseType="blob",n.onload=()=>t(n.response),n.send()}),r=await new Promise(t=>{const e=new FileReader;e.onload=e=>t(e.target.result),e.readAsDataURL(n)});t.set(e,r)}n.setAttribute("href",t.get(e))}return l?a("image",{x:n,y:r,width:o,height:i,href:"data:image/svg+xml;base64,"+btoa((new XMLSerializer).serializeToString(e))}):(()=>{const t=a("svg",{x:n,y:r,width:o,height:i,viewbox:`0 0 ${o} ${i}`});return t.innerHTML=e.innerHTML,t})()},h={__proto__:null,div:c,text:({fonts:t})=>async(r,{x:o,y:i,style:l},{splitText:s=!1})=>{if(!r)return;const c=a("g",{class:"text-fragment"}),g=t.find((h=l,({family:t,style:e="normal",weight:n="400"}={})=>{var r,o,i;return t===(null!=(r=h.getPropertyValue("font-family"))?r:"").replace(/['"]/g,"")&&e===(null!=(o=h.getPropertyValue("font-style"))?o:"normal")&&n===(null!=(i=h.getPropertyValue("font-weight"))?i:"400")}));var h;if(!g)throw new Error(`Cannot find font '${l.getPropertyValue("font-family")} ${l.getPropertyValue("font-style")} ${l.getPropertyValue("font-weight")}'`);const f=(u=n.join(__dirname,g.url),e.readFileSync(u).toString("base64"));var u;console.log(g),a("style",{},c).textContent=`\n    @font-face {\n      font-family: '${g.family}';\n      src: url(data:font/ttf;base64,${f}) format('truetype');\n      font-weight: ${g.weight};\n      font-style: ${g.style};\n    }\n  `;const d=l.getPropertyValue("letter-spacing"),y=l.getPropertyValue("font-size");return a("text",{x:o,y:i,fill:l.getPropertyValue("color"),"font-family":g.family,"font-size":y,"font-weight":l.getPropertyValue("font-weight"),"font-style":l.getPropertyValue("font-style"),"letter-spacing":"normal"===d?"0":d,"dominant-baseline":"hanging"},c).textContent=r,c},svg:g,DIV:c,CANVAS:({})=>async(t,{x:e,y:n,width:r,height:o})=>a("image",{x:e,y:n,width:r,height:o,href:t.toDataURL("image/png")}),IMG:({})=>async(t,{x:e,y:n,width:r,height:o})=>{if(r&&o&&t.src)return a("image",{x:e,y:n,width:r,height:o,href:t.src})},SVG:g};function f({debug:e=!1,ignore:n="",fonts:l=[]}={}){const s=new Map,c={};for(const t in h)c[t]=h[t]({debug:e,fonts:l,cache:s});return{get cache(){return s},preload:async function(){for(const e of l)e.opentype||(e.opentype=await new Promise(n=>{t.load(e.url,(t,e)=>{if(t)throw t;n(e)})}))},destroy:function(){s.clear();for(const t of l)delete t.opentype},render:async function(t,e={},l){const s=t.getBoundingClientRect(),g=a("svg",{viewBox:`0 0 ${s.width} ${s.height}`,width:s.width,height:s.height,preserveAspectRatio:"none"});let h=g;return await r(t,async r=>{var o;if(n&&r!==t&&r.matches(n))return;const f=window.getComputedStyle(r),{x:u,y:d,width:y,height:p}=r.getBoundingClientRect();if(r instanceof window.HTMLElement){const t=f.getPropertyValue("clip-path");"none"!==t&&(h=a("g",null,g),h.setAttribute("style",`clip-path: ${t.replace(/"/g,"'")}`))}const w=null!=(o=c[r.tagName])?o:c.div;let x=await w(r,{x:u-s.x,y:d-s.y,width:y,height:p,style:f},e);if(l&&(x=await l(r,x)),x&&h.appendChild(x),r.innerText&&r.childNodes.length){const t=a("g",{class:"text"});for(const n of r.childNodes)if(n.nodeType===Node.TEXT_NODE&&n.textContent.length)if(/^\s/.test(n.textContent))n.splitText(1);else for(const{rect:o,fragment:a}of i(n))try{let n=await c.text(a.textContent.trimEnd(),{x:o.x-s.x,y:o.y-s.y,width:o.width,height:o.height,style:f},e);l&&(n=await l(r,n)),n&&t.appendChild(n)}catch(t){console.warn(new Error(`Rendering failed for the following text: '${a.textContent}'`,{cause:t})),console.warn(t)}t.children.length&&h.appendChild(t)}return!0},{sort:(t,e)=>{var n,r;return t.zIndex=null!=(n=t.zIndex)?n:o(t),e.zIndex=null!=(r=e.zIndex)?r:o(e),t.zIndex-e.zIndex}}),g}}}export{f as default};
//# sourceMappingURL=html-to-svg.modern.mjs.map
