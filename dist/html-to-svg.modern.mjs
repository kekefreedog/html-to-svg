import t from"opentype.js";async function e(t,n,{sort:r=(()=>1)}={}){if(await n(t))for(const o of Array.from(t.children).sort(r))await e(o,n,{sort:r})}var n=t=>{const e=window.getComputedStyle(t).getPropertyValue("z-index");return"auto"===e?0:parseInt(null!=e?e:0)};function r(t,e=t.innerText||t.textContent){const n=document.createRange(),r=[];for(let a=0;a<t.length;a++){var o;n.setStart(t,0),n.setEnd(t,a+1);const i=n.getClientRects(),l=i.length-1;r[l]=null!=(o=r[l])?o:{text:""},r[l].rect=i[l],r[l].text+=e.charAt(a)}return r.map(t=>(t.fragment=new DocumentFragment,t.fragment.textContent=t.text,t))}function o(t,e={},n){const r="http://www.w3.org/2000/svg",o=document.createElementNS(r,t);"svg"===t&&o.setAttributeNS("http://www.w3.org/2000/xmlns/","xmlns",r);for(const t in e)null!=e[t]&&o.setAttribute(t,e[t]);return n&&n.appendChild(o),o}function a(){return a=Object.assign?Object.assign.bind():function(t){for(var e=1;e<arguments.length;e++){var n=arguments[e];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(t[r]=n[r])}return t},a.apply(this,arguments)}function i(t){return!t||"none"===t||"transparent"===t||!(!t.startsWith("rgba")||"0"!==t.match(/[\d.]+/g)[3])}var l=({})=>async(t,{x:e,y:n,width:r,height:l,style:s})=>{if(!r||!l)return;const c=s.getPropertyValue("background-color");if(i(c))return;const h={stroke:"none","stroke-width":1},g=s.getPropertyValue("border-color");return"none"===s.getPropertyValue("border-style")||i(g)||(h.stroke=g,h["stroke-width"]=s.getPropertyValue("border-width")),o("rect",a({x:e,y:n,width:r,height:l},h,{fill:c,rx:parseInt(s.getPropertyValue("border-radius"))||null}))},s=({cache:t})=>async(e,{x:n,y:r,width:a,height:i},{rasterizeNestedSVG:l=!0}={})=>{for(const n of e.querySelectorAll("image[href]")){const e=n.getAttribute("href");if(!t.has(e)){const n=await new Promise(t=>{const n=new XMLHttpRequest;n.open("GET",e,!0),n.responseType="blob",n.onload=()=>t(n.response),n.send()}),r=await new Promise(t=>{const e=new FileReader;e.onload=e=>t(e.target.result),e.readAsDataURL(n)});t.set(e,r)}n.setAttribute("href",t.get(e))}return l?o("image",{x:n,y:r,width:a,height:i,href:"data:image/svg+xml;base64,"+btoa((new XMLSerializer).serializeToString(e))}):(()=>{const t=o("svg",{x:n,y:r,width:a,height:i,viewbox:`0 0 ${a} ${i}`});return t.innerHTML=e.innerHTML,t})()},c={__proto__:null,div:l,text:({debug:t,fonts:e})=>async(n,{x:r,y:a,width:i,height:l,style:s},{splitText:c=!1})=>{if(!n)return;const h=o("g",{class:"text-fragment"}),g=e.find((d=s,({family:t,style:e="normal",weight:n="400"}={})=>{var r,o,a;return t===(null!=(r=d.getPropertyValue("font-family"))?r:"").replace(/['"]/g,"").replace("Open Sans","Helvetica")&&e===(null!=(o=d.getPropertyValue("font-style"))?o:"normal")&&n===(null!=(a=d.getPropertyValue("font-weight"))?a:"400")}));var d;if(!g)throw new Error(`Cannot find font '${s.getPropertyValue("font-family").replace("Open Sans","Helvetica")} ${s.getPropertyValue("font-style")} ${s.getPropertyValue("font-weight")}'`);const{unitsPerEm:u}=g.opentype,f=g.opentype.tables.hhea.ascender,p=g.opentype.tables.hhea.descender,y=s.getPropertyValue("letter-spacing"),w=parseFloat(s.getPropertyValue("font-size")),x=s.getPropertyValue("color"),m=w*((f-p)/u)-Math.abs(p/u)*w;return b("start",0,{orientation:"vertical",stroke:"red"}),b("end",i,{orientation:"vertical",stroke:"red"}),b("leading",m,{stroke:"#4b96ff"}),o("text",{x:r,y:a+m,fill:x,"font-family":s.getPropertyValue("font-family").replace(/['"]/g,"").replace("Open Sans","Helvetica"),"font-size":w,"font-weight":s.getPropertyValue("font-weight"),"font-style":s.getPropertyValue("font-style"),"letter-spacing":"normal"===y?"0":y,"dominant-baseline":"auto"},h).textContent=n,h;function b(e,n,{orientation:s="horizontal",stroke:c="black"}={}){return t&&o("line",{title:e,"data-value":n,x1:"horizontal"===s?r:r+n,x2:"horizontal"===s?r+i:r+n,y1:"horizontal"===s?a+n:a,y2:"horizontal"===s?a+n:a+l,stroke:c,class:"debug"},h)}},svg:s,DIV:l,CANVAS:({})=>async(t,{x:e,y:n,width:r,height:a})=>o("image",{x:e,y:n,width:r,height:a,href:t.toDataURL("image/png")}),IMG:({})=>async(t,{x:e,y:n,width:r,height:a})=>{if(r&&a&&t.src)return o("image",{x:e,y:n,width:r,height:a,href:t.src})},SVG:s};function h({debug:a=!0,ignore:i="",fonts:l=[]}={}){const s=new Map,h={};for(const t in c)h[t]=c[t]({debug:a,fonts:l,cache:s});return{get cache(){return s},preload:async function(){for(const e of l)e.opentype||(e.opentype=await new Promise(n=>{t.load(e.url,(t,e)=>{if(t)throw t;n(e)})}))},destroy:function(){s.clear();for(const t of l)delete t.opentype},render:async function(t,a={},l){const s=t.getBoundingClientRect(),c=o("svg",{viewBox:`0 0 ${s.width} ${s.height}`,width:s.width,height:s.height,preserveAspectRatio:"none"});let g=c;return await e(t,async e=>{var n;if(i&&e!==t&&e.matches(i))return;const d=window.getComputedStyle(e),{x:u,y:f,width:p,height:y}=e.getBoundingClientRect();if(e instanceof window.HTMLElement){const t=d.getPropertyValue("clip-path");"none"!==t&&(g=o("g",null,c),g.setAttribute("style",`clip-path: ${t.replace(/"/g,"'")}`))}const w=null!=(n=h[e.tagName])?n:h.div;let x=await w(e,{x:u-s.x,y:f-s.y,width:p,height:y,style:d},a);if(l&&(x=await l(e,x)),x&&g.appendChild(x),e.innerText&&e.childNodes.length){const t=o("g",{class:"text"});for(const n of e.childNodes)if(n.nodeType===Node.TEXT_NODE&&n.textContent.length)if(/^\s/.test(n.textContent))n.splitText(1);else for(const{rect:o,fragment:i}of r(n))try{let n=await h.text(i.textContent.trimEnd(),{x:o.x-s.x,y:o.y-s.y,width:o.width,height:o.height,style:d},a);l&&(n=await l(e,n)),n&&t.appendChild(n)}catch(t){console.warn(new Error(`Rendering failed for the following text: '${i.textContent}'`,{cause:t})),console.warn(t)}t.children.length&&g.appendChild(t)}return!0},{sort:(t,e)=>{var r,o;return t.zIndex=null!=(r=t.zIndex)?r:n(t),e.zIndex=null!=(o=e.zIndex)?o:n(e),t.zIndex-e.zIndex}}),c}}}export{h as default};
//# sourceMappingURL=html-to-svg.modern.mjs.map
